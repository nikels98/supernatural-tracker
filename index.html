<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Supernatural Episoden-Tracker (S1–15)</title>
<style>
  :root{
    --bg:#0c0f19;--panel:#121826;--muted:#9aa4bf;--text:#e8eefc;--line:#24304a;
    --accent:#6aa6ff;--accent2:#9d7dff;--ok:#41d392;--best:#153a22;--bestBorder:#2f7a52;
  }
  html,body{margin:0;background:linear-gradient(180deg,#0c0f19,#101522);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
  header{position:sticky;top:0;z-index:20;background:rgba(16,21,34,.9);backdrop-filter:blur(10px);
    border-bottom:1px solid var(--line); padding:10px 12px}
  h1{margin:0;font-size:clamp(18px,3.5vw,24px)}
  .sub{color:var(--muted);font-size:12px;margin-top:4px}
  .summary{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px;margin-top:10px}
  .pill{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px 12px}
  .pill b{display:block;font-size:18px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  button{background:var(--panel);border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  button:hover{border-color:#3a4a72}
  input[type="number"]{width:80px;background:#0a0f1a;border:1px solid var(--line);border-radius:8px;color:var(--text);padding:6px}
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  details{margin:10px 0;border:1px solid var(--line);border-radius:14px;overflow:hidden}
  summary{list-style:none;cursor:pointer;padding:12px 14px;background:var(--panel);display:flex;align-items:center;gap:10px}
  summary::marker, summary::-webkit-details-marker{display:none}
  .badge{font-size:12px;color:var(--muted)}
  .season{padding:10px 14px;background:linear-gradient(180deg,#0f1524,#0d1220)}
  .progress{height:8px;background:#101728;border:1px solid var(--line);border-radius:6px;overflow:hidden;margin:6px 0 10px 0}
  .bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}
  .list{border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .row{display:grid;grid-template-columns:84px 1fr 84px;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid #101828}
  .row:last-child{border-bottom:none}
  .code{font-variant-numeric:tabular-nums;font-weight:700}
  .title{opacity:.98}
  .best{background:var(--best);border-left:3px solid var(--bestBorder)}
  .best .code::before{content:"✔ ";color:var(--ok);margin-right:2px}
  .foot{color:var(--muted);font-size:12px;margin-top:6px}
  .float{position:fixed;right:14px;bottom:14px;background:#0b1222;border:1px solid var(--line);
    border-radius:14px;padding:10px 12px;z-index:30;max-width:260px}
  .float h4{margin:0 0 6px 0;font-size:14px}
  .hint{color:var(--muted);font-size:12px;margin-top:8px}
  @media (max-width:800px){.summary{grid-template-columns:repeat(2,1fr)} .row{grid-template-columns:78px 1fr 70px}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Supernatural Episoden-Tracker <span class="sub">Special Folgen (grün) & komplett · Staffeln 1–15</span></h1>
    <div class="summary">
      <div class="pill"><div class="sub">Special Folgen (gesamt)</div><b id="specialTotal">0</b><span class="foot" id="specialTotalHours"></span></div>
      <div class="pill"><div class="sub">Alle Folgen (gesamt)</div><b id="allTotal">0</b><span class="foot" id="allTotalHours"></span></div>
      <div class="pill"><div class="sub">Übrig – Special</div><b id="remBest">0h</b><span class="foot" id="remBestEps"></span></div>
      <div class="pill"><div class="sub">Übrig – Alle</div><b id="remAll">0h</b><span class="foot" id="remAllEps"></span></div>
    </div>
    <div class="toolbar">
      <button id="toggleBest">Nur Special zeigen</button>
      <button id="showAll">Alles zeigen</button>
      <button id="resetChecks">Alle Haken löschen</button>
      <button id="reloadTitles">Titel neu laden</button>
      <span class="pill">
        <span class="sub">Ø Minuten pro Folge</span>
        <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
          <input type="number" id="avgMin" value="42" min="20" max="90">
          <button id="recalcBtn">Neu berechnen</button>
        </div>
      </span>
    </div>
    <div class="hint" id="titleHint">Lade Episodentitel… (passiert automatisch beim ersten Start; werden lokal gespeichert)</div>
  </div>
</header>

<div class="wrap">
  <div id="seasons"></div>
  <div class="foot">Speicherung läuft lokal im Browser (LocalStorage). „Special Folgen“ = unsere Best-of-Sammlung (Main-Plot, Castiel, Crowley, MOL, Zeitreisen, Comedy/Kult).</div>
</div>

<div class="float">
  <h4>Live-Timer</h4>
  <div class="sub">Special übrig</div>
  <div style="font-weight:700" id="miniBest">0h</div>
  <div class="sub" style="margin-top:6px">Alle übrig</div>
  <div style="font-weight:700" id="miniAll">0h</div>
</div>

<script>
/* ---------- Stammdaten ---------- */
const FULL = {1:22,2:22,3:16,4:22,5:22,6:22,7:23,8:23,9:23,10:23,11:23,12:23,13:23,14:20,15:20};
const SPECIAL = new Set([
  // S1–9 (unsere Special/Best-of)
  "1x01","1x09","1x16","1x19","1x21","1x22",
  "2x01","2x10","2x14","2x15","2x18","2x20","2x21","2x22",
  "3x01","3x03","3x11","3x12","3x13","3x16",
  "4x01","4x03","4x06","4x07","4x08","4x09","4x10","4x18","4x20","4x21","4x22",
  "5x01","5x03","5x04","5x08","5x09","5x10","5x13","5x20","5x21","5x22",
  "6x01","6x03","6x05","6x07","6x09","6x10","6x15","6x17","6x18","6x20","6x21","6x22",
  "7x01","7x02","7x10","7x17","7x21","7x23",
  "8x01","8x02","8x07","8x08","8x10","8x12","8x13","8x14","8x17","8x19","8x21","8x22","8x23",
  "9x01","9x03","9x04","9x06","9x09","9x10","9x11","9x16","9x18","9x21","9x22","9x23",
  // S10–15 Highlights
  "10x05","10x14","10x22","10x23",
  "11x04","11x10","11x20","11x23",
  "12x01","12x12","12x22","12x23",
  "13x01","13x16","13x23",
  "14x10","14x13","14x20",
  "15x01","15x18","15x19","15x20"
]);

/* ---------- Helpers ---------- */
const LS_STATE = "spn_state_v3";
const LS_TITLES = "spn_titles_v1";
const $ = q => document.querySelector(q);
function seasonCodes(s){return Array.from({length:FULL[s]},(_,i)=>`${s}x${String(i+1).padStart(2,"0")}`)}
function loadState(){try{return JSON.parse(localStorage.getItem(LS_STATE)||"{}")}catch{return {}}}
function saveState(s){localStorage.setItem(LS_STATE,JSON.stringify(s))}
function loadTitles(){try{return JSON.parse(localStorage.getItem(LS_TITLES)||"{}")}catch{return {}}}
function saveTitles(t){localStorage.setItem(LS_TITLES,JSON.stringify(t))}
function fmtHours(min){const h=min/60; return h>=10?`${h.toFixed(0)}h`:`${h.toFixed(1)}h`}

/* ---------- App State ---------- */
let STATE = loadState();   // {"4x06": true, ...}
let TITLES = loadTitles(); // {"4x06": "Yellow Fever", ...}
let ONLY_SPECIAL = false;

/* ---------- Titel-Loader (Wikipedia) ---------- */
async function fetchSeasonTitles(season){
  const url = `https://en.wikipedia.org/w/api.php?action=parse&format=json&origin=*&page=Supernatural_(season_${season})&prop=wikitext`;
  const res = await fetch(url);
  if(!res.ok) throw new Error("HTTP "+res.status);
  const data = await res.json();
  const wikitext = data?.parse?.wikitext?.["*"] || "";
  const lines = wikitext.split("\\n");
  const titles = [];
  for(let ln of lines){
    let m = ln.match(/\\|\\s*title\\s*=\\s*("?)(.+?)\\1\\s*(?:\\||$)/i);
    if(!m){ m = ln.match(/\\|\\s*Title\\s*=\\s*("?)(.+?)\\1\\s*(?:\\||$)/); }
    if(!m){ m = ln.match(/\\|\\s*.*?''([^']{2,}?)''/); }
    if(m){
      let t = m[2] || m[1] || m[0];
      t = t.replace(/\\[\\[(?:[^\\|\\]]+\\|)?([^\\]]+)\\]\\]/g,"$1");
      t = t.replace(/''+/g,"");
      t = t.replace(/<ref[^>]*>.*?<\\/ref>/g,"");
      t = t.replace(/&quot;/g,'"').replace(/&amp;/g,'&');
      t = t.replace(/\\{\\{.*?\\}\\}/g,"").trim();
      if(t && !/^\\|/.test(t) && !/^\\d+$/.test(t)) titles.push(t);
    }
  }
  const codes = seasonCodes(season);
  const map = {};
  for(let i=0;i<codes.length;i++){ map[codes[i]] = (titles[i]||"—").trim(); }
  return map;
}

async function ensureTitles(){
  // Falls schon alle da sind, nichts tun
  let missing = [];
  for(let s=1;s<=15;s++){
    const codes = seasonCodes(s);
    if(!codes.every(c=>TITLES[c])) missing.push(s);
  }
  if(missing.length===0){ $("#titleHint").textContent = "Alle Episodentitel geladen."; return; }

  $("#titleHint").textContent = "Lade Episodentitel …";
  for(const s of missing){
    try{
      const map = await fetchSeasonTitles(s);
      Object.assign(TITLES, map);
      saveTitles(TITLES);
      $("#titleHint").textContent = `Titel geladen: Staffel ${s}/15`;
    }catch(err){
      console.error("Fehler Staffel", s, err);
      $("#titleHint").textContent = `Fehler beim Laden von Staffel ${s}. Du kannst „Titel neu laden“ nutzen.`;
      break;
    }
  }
  $("#titleHint").textContent = "Titel-Cache aktiv. (Knopf „Titel neu laden“ aktualisiert bei Bedarf.)";
  render(); // Titel anzeigen
}

/* ---------- Render ---------- */
const host = document.getElementById("seasons");
function render(){
  host.innerHTML = "";
  const avg = Number($("#avgMin").value)||42;

  // Totals
  let specialTotal = 0, allTotal = 0;
  for(let s=1;s<=15;s++){
    const codes = seasonCodes(s);
    allTotal += codes.length;
    specialTotal += codes.filter(c=>SPECIAL.has(c)).length;
  }
  $("#specialTotal").textContent = specialTotal;
  $("#allTotal").textContent = allTotal;
  $("#specialTotalHours").textContent = `≈ ${fmtHours(specialTotal*avg)} insgesamt`;
  $("#allTotalHours").textContent = `≈ ${fmtHours(allTotal*avg)} insgesamt`;

  let totalAllMin = allTotal * avg;
  let totalSpecialMin = specialTotal * avg;
  let seenAllMin = 0, seenSpecialMin = 0;

  for(let s=1;s<=15;s++){
    const codes = seasonCodes(s);
    const specialCodes = codes.filter(c=>SPECIAL.has(c));
    const seenCodes = codes.filter(c=>STATE[c]);
    const seenSpecialCodes = specialCodes.filter(c=>STATE[c]);

    seenAllMin += seenCodes.length * avg;
    seenSpecialMin += seenSpecialCodes.length * avg;

    const det = document.createElement("details");
    det.open = (s<=2);
    const sumEl = document.createElement("summary");
    sumEl.innerHTML = `<strong>Staffel ${s}</strong>
      <span class="badge">• Special: ${specialCodes.length} · Alle: ${codes.length}</span>
      <span class="badge">• gesehen: ${seenCodes.length}/${codes.length}</span>`;
    det.appendChild(sumEl);

    const box = document.createElement("div");
    box.className = "season";

    const prog = document.createElement("div");
    prog.className = "progress";
    const bar = document.createElement("div");
    bar.className = "bar";
    bar.style.width = `${(seenCodes.length/codes.length)*100}%`;
    prog.appendChild(bar);
    box.appendChild(prog);

    const btns = document.createElement("div");
    btns.style.display="flex";btns.style.gap="8px";btns.style.flexWrap="wrap";btns.style.margin="6px 0 10px 0";
    const checkAll = document.createElement("button"); checkAll.textContent="Staffel abhaken";
    checkAll.onclick = ()=>{codes.forEach(c=>STATE[c]=true); saveState(STATE); render();};
    const uncheckAll = document.createElement("button"); uncheckAll.textContent="Haken der Staffel löschen";
    uncheckAll.onclick = ()=>{codes.forEach(c=>delete STATE[c]); saveState(STATE); render();};
    btns.append(checkAll, uncheckAll);
    box.appendChild(btns);

    const list = document.createElement("div"); list.className = "list";
    codes.forEach(code=>{
      const isSpecial = SPECIAL.has(code);
      if(ONLY_SPECIAL && !isSpecial) return;
      const row = document.createElement("div"); row.className = "row" + (isSpecial?" best":"");
      const codeEl = document.createElement("div"); codeEl.className="code"; codeEl.textContent = code;
      const titleEl = document.createElement("div"); titleEl.className="title"; titleEl.textContent = TITLES[code] || "—";
      const chkWrap = document.createElement("div");
      const chk = document.createElement("input"); chk.type="checkbox"; chk.checked=!!STATE[code];
      chk.onchange = ()=>{ if(chk.checked){STATE[code]=true}else{delete STATE[code]} saveState(STATE); render(); };
      chkWrap.appendChild(chk);
      row.append(codeEl,titleEl,chkWrap);
      list.appendChild(row);
    });
    box.appendChild(list);

    const line = document.createElement("div");
    line.className="foot";
    const leftSpecial = Math.max(0, (specialCodes.length - seenSpecialCodes.length) * avg);
    const leftAll = Math.max(0, (codes.length - seenCodes.length) * avg);
    line.innerHTML = `Übrig – Special: <b>${fmtHours(leftSpecial)}</b> (${specialCodes.length - seenSpecialCodes.length} Folgen)
      &nbsp;|&nbsp; Übrig – Alle: <b>${fmtHours(leftAll)}</b> (${codes.length - seenCodes.length} Folgen)`;
    box.appendChild(line);

    det.appendChild(box);
    host.appendChild(det);
  }

  // Header totals remaining
  const remBestMin = Math.max(0, totalSpecialMin - seenSpecialMin);
  const remAllMin  = Math.max(0, totalAllMin - seenAllMin);
  $("#remBest").textContent = fmtHours(remBestMin);
  $("#remBestEps").textContent = `${Math.round(remBestMin/avg)} Folgen übrig`;
  $("#remAll").textContent = fmtHours(remAllMin);
  $("#remAllEps").textContent = `${Math.round(remAllMin/avg)} Folgen übrig`;

  // Floating mini
  $("#miniBest").textContent = fmtHours(remBestMin);
  $("#miniAll").textContent  = fmtHours(remAllMin);
}

/* ---------- UI ---------- */
$("#toggleBest").onclick = ()=>{ONLY_SPECIAL=true; render();};
$("#showAll").onclick = ()=>{ONLY_SPECIAL=false; render();};
$("#recalcBtn").onclick = ()=>render();
$("#resetChecks").onclick = ()=>{
  if(confirm("Alle Haken wirklich löschen?")){ STATE={}; saveState(STATE); render(); }
};
$("#reloadTitles").onclick = ()=>{ localStorage.removeItem(LS_TITLES); TITLES={}; $("#titleHint").textContent="Titel werden neu geladen …"; ensureTitles(); };

/* ---------- Init ---------- */
render();
ensureTitles(); // lädt Titel automatisch beim ersten Start
</script>
</body>
</html>